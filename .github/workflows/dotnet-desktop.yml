name: EFT-DMA-Radar Release

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: windows-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            10.0.x

      - name: Install Velopack CLI
        run: dotnet tool install -g vpk

      - name: Calculate Version
        id: version
        run: |
          COMMIT_COUNT=$(git rev-list --count HEAD)
          VERSION="1.0.$COMMIT_COUNT"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Publish
        run: |
          dotnet publish src/Lone-EFT-DMA-Radar.csproj `
            -c Release `
            -r win-x64 `
            --no-self-contained `
            /p:PublishSingleFile=true `
            /p:DebugType=none `
            /p:Version=${{ steps.version.outputs.VERSION }} `
            /p:FileVersion=${{ steps.version.outputs.VERSION }} `
            /p:AssemblyVersion=${{ steps.version.outputs.VERSION }} `
            -o out

      - name: Pack with Velopack
        run: |
          vpk pack `
            --packId github.lumos36.eft `
            --packVersion "${{ steps.version.outputs.VERSION }}" `
            --packDir "out" `
            --mainExe "Lone-EFT-DMA-Radar.exe" `
            --packTitle "Lone EFT DMA Radar" `
            --icon "Resources/lone-icon.ico"

      - name: Upload to GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          vpk upload github `
            --repoUrl "https://github.com/${{ github.repository }}" `
            --publish `
            --releaseName "EFT ${{ steps.version.outputs.VERSION }}" `
            --tag "v${{ steps.version.outputs.VERSION }}" `
            --targetCommitish "${{ github.sha }}" `
            --token "$env:GITHUB_TOKEN"
